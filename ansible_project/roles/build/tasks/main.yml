- name: Ensure target directory is removed to avoid permission issues
  file:
    path: /home/dhayanidhi-s/ci_cd_workspace/target
    state: absent

- name: Build the Java project using Maven
  command: mvn clean package
  args:
    chdir: /home/dhayanidhi-s/ci_cd_workspace
  register: build_result
  ignore_errors: yes  # ✅ Allow the playbook to continue even on failure

- name: Create rollback trigger file if build failed
  file:
    path: /tmp/build_failed
    state: touch
  when: build_result.rc != 0  # ✅ Only create this file on failure

- name: Remove rollback trigger file if build succeeded
  file:
    path: /tmp/build_failed
    state: absent
  when: build_result.rc == 0  # ✅ Clean up for successful builds
